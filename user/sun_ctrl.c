
#include <stdbool.h>

#include "sun_ctrl.h"
#include "logic.h"

extern configuration_t cfg_data;

uint16_t _scale_intensity_to_lut(uint32_t intensity);

uint8_t _last_user_sun_intensity;

// clang-format off
// Gamma brightness lookup table <https://victornpb.github.io/gamma-table-generator>
// gamma = 3.30 steps = 1200 range = 0-65535
#define LUT_SIZE 1200
const uint16_t gamma_lut[LUT_SIZE] = {
     0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
     0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
     0,   0,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,
     2,   2,   2,   2,   2,   2,   2,   3,   3,   3,   3,   3,   3,   4,   4,   4,
     4,   4,   5,   5,   5,   5,   6,   6,   6,   6,   7,   7,   7,   8,   8,   8,
     9,   9,   9,  10,  10,  11,  11,  11,  12,  12,  13,  13,  14,  14,  15,  15,
    16,  16,  17,  17,  18,  19,  19,  20,  21,  21,  22,  23,  23,  24,  25,  25,
    26,  27,  28,  29,  29,  30,  31,  32,  33,  34,  35,  36,  37,  38,  39,  40,
    41,  42,  43,  44,  45,  46,  47,  49,  50,  51,  52,  53,  55,  56,  57,  59,
    60,  62,  63,  64,  66,  67,  69,  70,  72,  73,  75,  77,  78,  80,  82,  83,
    85,  87,  89,  90,  92,  94,  96,  98, 100, 102, 104, 106, 108, 110, 112, 114,
   117, 119, 121, 123, 126, 128, 130, 133, 135, 137, 140, 142, 145, 147, 150, 153,
   155, 158, 161, 163, 166, 169, 172, 175, 178, 181, 184, 187, 190, 193, 196, 199,
   202, 206, 209, 212, 215, 219, 222, 226, 229, 233, 236, 240, 243, 247, 251, 255,
   258, 262, 266, 270, 274, 278, 282, 286, 290, 294, 298, 303, 307, 311, 316, 320,
   324, 329, 333, 338, 343, 347, 352, 357, 361, 366, 371, 376, 381, 386, 391, 396,
   401, 407, 412, 417, 422, 428, 433, 439, 444, 450, 455, 461, 467, 473, 478, 484,
   490, 496, 502, 508, 514, 521, 527, 533, 540, 546, 552, 559, 565, 572, 579, 585,
   592, 599, 606, 613, 620, 627, 634, 641, 648, 655, 663, 670, 677, 685, 692, 700,
   708, 715, 723, 731, 739, 747, 755, 763, 771, 779, 787, 796, 804, 813, 821, 830,
   838, 847, 856, 864, 873, 882, 891, 900, 909, 919, 928, 937, 947, 956, 965, 975,
   985, 994,1004,1014,1024,1034,1044,1054,1064,1074,1085,1095,1106,1116,1127,1137,
  1148,1159,1170,1181,1192,1203,1214,1225,1236,1248,1259,1271,1282,1294,1306,1318,
  1329,1341,1353,1366,1378,1390,1402,1415,1427,1440,1452,1465,1478,1491,1504,1517,
  1530,1543,1556,1570,1583,1597,1610,1624,1638,1651,1665,1679,1693,1708,1722,1736,
  1751,1765,1780,1794,1809,1824,1839,1854,1869,1884,1899,1914,1930,1945,1961,1977,
  1992,2008,2024,2040,2056,2073,2089,2105,2122,2138,2155,2172,2188,2205,2222,2239,
  2257,2274,2291,2309,2326,2344,2362,2380,2398,2416,2434,2452,2470,2489,2507,2526,
  2544,2563,2582,2601,2620,2639,2659,2678,2697,2717,2737,2756,2776,2796,2816,2837,
  2857,2877,2898,2918,2939,2960,2981,3002,3023,3044,3065,3086,3108,3130,3151,3173,
  3195,3217,3239,3261,3284,3306,3329,3351,3374,3397,3420,3443,3466,3490,3513,3536,
  3560,3584,3608,3632,3656,3680,3704,3729,3753,3778,3802,3827,3852,3877,3903,3928,
  3953,3979,4004,4030,4056,4082,4108,4134,4161,4187,4214,4241,4267,4294,4321,4349,
  4376,4403,4431,4458,4486,4514,4542,4570,4598,4627,4655,4684,4713,4742,4771,4800,
  4829,4858,4888,4917,4947,4977,5007,5037,5067,5098,5128,5159,5189,5220,5251,5282,
  5314,5345,5377,5408,5440,5472,5504,5536,5568,5601,5633,5666,5699,5732,5765,5798,
  5831,5865,5898,5932,5966,6000,6034,6068,6103,6137,6172,6207,6242,6277,6312,6348,
  6383,6419,6455,6490,6527,6563,6599,6636,6672,6709,6746,6783,6820,6857,6895,6933,
  6970,7008,7046,7084,7123,7161,7200,7239,7278,7317,7356,7395,7435,7474,7514,7554,
  7594,7634,7675,7715,7756,7797,7838,7879,7920,7962,8003,8045,8087,8129,8171,8213,
  8256,8299,8341,8384,8427,8471,8514,8558,8601,8645,8689,8733,8778,8822,8867,8912,
  8957,9002,9047,9093,9138,9184,9230,9276,9322,9369,9415,9462,9509,9556,9603,9651,
  9698,9746,9794,9842,9890,9938,9987,10036,10084,10133,10183,10232,10281,10331,10381,10431,
  10481,10532,10582,10633,10684,10735,10786,10837,10889,10941,10992,11044,11097,11149,11202,11254,
  11307,11360,11414,11467,11521,11575,11628,11683,11737,11791,11846,11901,11956,12011,12066,12122,
  12178,12234,12290,12346,12402,12459,12516,12573,12630,12687,12745,12803,12860,12919,12977,13035,
  13094,13153,13212,13271,13330,13390,13449,13509,13569,13630,13690,13751,13812,13873,13934,13995,
  14057,14119,14181,14243,14305,14368,14430,14493,14556,14620,14683,14747,14811,14875,14939,15004,
  15068,15133,15198,15263,15329,15394,15460,15526,15592,15659,15725,15792,15859,15926,15994,16061,
  16129,16197,16265,16334,16402,16471,16540,16609,16679,16748,16818,16888,16958,17029,17099,17170,
  17241,17312,17384,17455,17527,17599,17672,17744,17817,17890,17963,18036,18109,18183,18257,18331,
  18405,18480,18555,18630,18705,18780,18856,18932,19008,19084,19160,19237,19314,19391,19468,19546,
  19624,19701,19780,19858,19937,20015,20094,20174,20253,20333,20413,20493,20573,20654,20734,20815,
  20897,20978,21060,21142,21224,21306,21389,21471,21554,21637,21721,21805,21888,21973,22057,22141,
  22226,22311,22396,22482,22568,22653,22740,22826,22913,22999,23086,23174,23261,23349,23437,23525,
  23614,23702,23791,23880,23970,24059,24149,24239,24329,24420,24511,24602,24693,24784,24876,24968,
  25060,25153,25245,25338,25431,25525,25618,25712,25806,25901,25995,26090,26185,26280,26376,26472,
  26568,26664,26760,26857,26954,27051,27149,27247,27344,27443,27541,27640,27739,27838,27937,28037,
  28137,28237,28338,28438,28539,28640,28742,28844,28945,29048,29150,29253,29356,29459,29562,29666,
  29770,29874,29979,30083,30188,30293,30399,30505,30611,30717,30823,30930,31037,31144,31252,31360,
  31468,31576,31685,31793,31902,32012,32121,32231,32341,32452,32562,32673,32785,32896,33008,33120,
  33232,33344,33457,33570,33683,33797,33911,34025,34139,34254,34369,34484,34599,34715,34831,34947,
  35064,35181,35298,35415,35533,35650,35769,35887,36006,36125,36244,36363,36483,36603,36723,36844,
  36965,37086,37208,37329,37451,37573,37696,37819,37942,38065,38189,38313,38437,38562,38686,38811,
  38937,39062,39188,39314,39441,39568,39695,39822,39950,40078,40206,40334,40463,40592,40721,40851,
  40981,41111,41241,41372,41503,41635,41766,41898,42030,42163,42296,42429,42562,42696,42830,42964,
  43098,43233,43368,43504,43639,43775,43912,44048,44185,44322,44460,44598,44736,44874,45013,45152,
  45291,45431,45571,45711,45851,45992,46133,46274,46416,46558,46700,46843,46986,47129,47272,47416,
  47560,47705,47850,47995,48140,48285,48431,48578,48724,48871,49018,49166,49314,49462,49610,49759,
  49908,50057,50207,50357,50507,50658,50808,50960,51111,51263,51415,51568,51720,51873,52027,52181,
  52335,52489,52644,52799,52954,53110,53266,53422,53578,53735,53893,54050,54208,54366,54525,54684,
  54843,55002,55162,55322,55482,55643,55804,55966,56128,56290,56452,56615,56778,56941,57105,57269,
  57433,57598,57763,57928,58094,58260,58426,58593,58760,58927,59095,59263,59431,59600,59769,59938,
  60108,60278,60448,60619,60790,60961,61133,61305,61477,61650,61823,61996,62170,62344,62518,62693,
  62868,63044,63219,63395,63572,63749,63926,64103,64281,64459,64637,64816,64995,65175,65355,65535,
};
// clang-format on

void sun_init(void)
{
  LL_TIM_EnableUpdateEvent(SUN_TIM);

  sun_set_intensity(cfg_data.sun_manual_intensity);
  LL_TIM_SetCounter(SUN_TIM, 0);
  LL_TIM_EnableAllOutputs(SUN_TIM);
}

void sun_pwr_on(void)
{
  LL_TIM_GenerateEvent_UPDATE(SUN_TIM);
  LL_TIM_SetCounter(SUN_TIM, 0);
  LL_TIM_CC_EnableChannel(SUN_TIM, SUN_TIM_CH);
  LL_TIM_EnableCounter(SUN_TIM);
}

void sun_pwr_off(void)
{
  LL_TIM_DisableCounter(SUN_TIM);
  LL_TIM_CC_DisableChannel(SUN_TIM, SUN_TIM_CH);
}

void sun_pwr_on_manual(void)
{
  sun_set_intensity(cfg_data.sun_manual_intensity);
  sun_pwr_on();
}

void sun_set_intensity(uint8_t intensity)
{
  // percent to value conversion
  // intensity: 0 ... 100 (SUN_INTENSITY_MAX)
  uint32_t compare_val = 0;

  _last_user_sun_intensity = intensity;
  if (intensity)
  {
    compare_val = _scale_intensity_to_lut(get_sun_intensity_value(intensity));
  }
  LL_TIM_OC_SetCompareCH4(SUN_TIM, compare_val);
}

uint8_t sun_get_intensity(void)
{
  // return last intensity that was set via `set_sun_intensity()`
  // return: 0 ... SUN_INTENSITY_MAX
  return _last_user_sun_intensity;
}

uint16_t _scale_intensity_to_lut(uint32_t intensity)
{
  // scale intensity range to length of LUT
  // intensity 0 ... (cfg_data.intensity_resolution -1)
  // return: LUT[0] ... LUT[-1]
  uint16_t idx_in_lut = (intensity * LUT_SIZE) / cfg_data.intensity_resolution;

  return gamma_lut[idx_in_lut];
}

void sun_set_intensity_precise(uint32_t intensity)
{
  // 0 ... cfg_data.intensity_resolution -1
  uint32_t compare_val = 0;

  if (intensity)
  {
    compare_val = _scale_intensity_to_lut(intensity);
  }
  LL_TIM_OC_SetCompareCH4(SUN_TIM, compare_val);
}

uint32_t get_sun_intensity_value(uint8_t user_intensity)
{
  // user_intensity: 1 ... 100 (SUN_INTENSITY_MAX)
  // return: cfg_data.intensity_resolution/SUN_INTENSITY_MAX -1  ... cfg_data.intensity_resolution -1

  return ((cfg_data.intensity_resolution * (uint32_t)user_intensity) / SUN_INTENSITY_MAX) - 1;
}
